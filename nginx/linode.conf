# nginx config for Linode:
# Hosts
# - www.futomen.net
#   880  -> docker 80
#   1443 -> docker 443
# - nextcloud
#   881  -> docker 80
#   1443 -> docker 443


server {
    listen 80;
    server_name www.futomen.net;

    location / {
        proxy_pass http://localhost:880;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;        
    }

    access_log /var/log/nginx/futomen.access.log;
    error_log /var/log/nginx/futomen.error.log;
}

server {
    listen 443 ssl;
    server_name www.futomen.net;

    ssl_certificate /var/www/certs/namecheap/futomen_net.crt;
    ssl_certificate_key /var/www/certs/namecheap/futomen_net.key;
    ssl_protocols        SSLv3 TLSv1.2;
    ssl_ciphers          HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://localhost:880;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    access_log /var/log/nginx/futomen_secure.access.log;
    error_log /var/log/nginx/futomen_secure.error.log;
}

# Nextcloud setup from https://github.com/nextcloud/all-in-one/blob/main/reverse-proxy.md#nginx
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# Current debian 11 nginx:
# wyan@lnjpdeb0:~$ /sbin/nginx -v
# nginx version: nginx/1.18.0
server {
    listen 80 default_server;
    listen [::]:80;            # comment to disable IPv6

    if ($scheme = "http") {
        return 301 https://$host$request_uri;
    }

    listen 443 ssl http2 default_server;      # for nginx versions below v1.25.1
    listen [::]:443 ssl http2; # for nginx versions below v1.25.1 - comment to disable IPv6

    # listen 443 ssl;      # for nginx v1.25.1+
    # listen [::]:443 ssl; # for nginx v1.25.1+ - keep comment to disable IPv6
	
    # http2 on;                                 # uncomment to enable HTTP/2        - supported on nginx v1.25.1+
    # http3 on;                                 # uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+
    # quic_retry on;                            # uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+
    # add_header Alt-Svc 'h3=":443"; ma=86400'; # uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+
    # listen 443 quic reuseport;       # uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+ - please remove "reuseport" if there is already another quic listener on port 443 with enabled reuseport
    # listen [::]:443 quic reuseport;  # uncomment to enable HTTP/3 / QUIC - supported on nginx v1.25.0+ - please remove "reuseport" if there is already another quic listener on port 443 with enabled reuseport - keep comment to disable IPv6

    server_name nextcloud.futomen.net;

    location / {
        proxy_pass http://127.0.0.1:11000$request_uri;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Scheme $scheme;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Accept-Encoding "";
        proxy_set_header Host $host;
    
        client_body_buffer_size 512k;
        proxy_read_timeout 86400s;
        client_max_body_size 0;

        # Websocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Same as www because it's wildcard
    ssl_certificate /var/www/certs/namecheap/futomen_net.crt;
    ssl_certificate_key /var/www/certs/namecheap/futomen_net.key;
    ssl_protocols        SSLv3 TLSv1.2;
    ssl_ciphers          HIGH:!aNULL:!MD5;

    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m; # about 40000 sessions
    ssl_session_tickets off;

    # Optional settings:

    # OCSP stapling
    # ssl_stapling on;
    # ssl_stapling_verify on;
    # ssl_trusted_certificate /etc/letsencrypt/live/<your-nc-domain>/chain.pem;

    # replace with the IP address of your resolver
    # resolver 127.0.0.1; # needed for oscp stapling: e.g. use 94.140.15.15 for adguard / 1.1.1.1 for cloudflared or 8.8.8.8 for google - you can use the same nameserver as listed in your /etc/resolv.conf file
    # I assume this is linode's server
    resolver 100.100.100.100;


    access_log /var/log/nginx/nextcloud.access.log;
    error_log /var/log/nginx/nextcloud.error.log;

}
